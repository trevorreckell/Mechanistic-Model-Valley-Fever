% Local Sensitivity Analysis for the Models
% Forward Sensitivity Analysis (FSA)

clear; clc; close all;

%% 1: Define Initial Conditions and Parameters
% 
fprintf('Setting up the expanded model...\n');
global alpha_h_maricopa omega_maricopa alpha_h_pinal omega_pinal alpha_h_pima omega_pima alpha_h_AZ omega_AZ
alpha_h_maricopa= 0.000035386745035+0.049996054144265;
omega_maricopa= 0.049996054144265;

alpha_h_pinal= 0.000054197479825+0.049562154054803; %*use looser bounds
omega_pinal= 0.049562154054803; %*use looser bounds

alpha_h_pima= 0.000010637066754+0.050079359342677;
omega_pima= 0.050079359342677;

alpha_h_AZ= 0.002876562772732+0.058375000164113;
omega_AZ= 0.058375000164113;

%import/load data
y_pop_data_Maricopa=[4018657;4425315;4585871;4673096];
y_pop_data_Pinal=[394200;425264;484239;513862];
y_pop_data_Pima=[1024000;1043433;1063162;1080149];
y_pop_data_AZ=[6849647;7151502;7431344;7582384];

y_inf_data_Maricopa=[565.4;514;323.7142857;232.7142857;258.1428571;...
    294.1428571;286;305;324.2857143;281.4285714;337.2857143;500.2857143;...
    460;406.7142857;439;418.2857143;372.2857143;419.7142857;353.1428571;227;...
    224.7142857;253.2857143;223.1428571;225.2857143;315.4285714;244;268;...
    312.2857143;364.2857143;331.5714286;448.8571429;501.7142857;557.5714286;...
    674.2857143;553.4285714;586.2857143;505.7142857;414.5714286;340.4285714;...
    427.8571429;369.1428571;318.8571429;333.7142857;327.5714286;369.7142857;...
    284;425.1428571;427.1428571;398.8571429;370.4285714;290;264;305.7142857;...
    310.7142857;290.8571429;345.5714286;364.1428571;323.5714286;477.8571429;...
    721.1428571;905;702.7142857;437.5714286;428.7142857;421;481;430;494.5714286;...
    448;389.8571429;461.7142857;362.4285714;464.4285714;555;440.4285714;...
    567.5714286;514;545.2857143;556.1428571;657.8571429;666.7142857;575;...
    631.7142857;806.2857143;754;677;597;463.4285714;305.5714286;415.4285714;...
    500.7142857;535.4285714;735;860;882.4285714;1035.571429;1150.428571;...
    994.2857143;804.7142857;829.4285714;637.5714286;620.8571429;605.7142857;...
    571.4285714;613.8571429;529.4285714;646.1428571;773.2857143;919.2857143;...
    708.8571429;514.2857143;501.7142857;593.1428571;692.5714286;669.7142857;...
    773.7142857;525.5714286;442.7142857;430.4285714;514.1428571;558.1428571;...
    501.4285714;433.2857143;548.8571429;511.4285714;542;491.1428571;...
    609.7142857;704;689.1428571;842.4285714;989.1428571;1072.428571];

y_inf_data_Pinal=[53.74285714;48.85714286;36.28571429;15.42857143;17.71428571;...
    34.14285714;33.57142857;30.57142857;35.42857143;25.42857143;34.14285714;...
    41.42857143;61;38.85714286;35.14285714;54.85714286;43.71428571;57.42857143;...
    40.14285714;27.42857143;33.42857143;28.14285714;22.28571429;30;33.57142857;...
    37;32;37.57142857;48.28571429;42.14285714;48.71428571;60.42857143;...
    68.71428571;71.28571429;78.85714286;73.14285714;56.85714286;47.85714286;...
    42.14285714;42.14285714;57.85714286;32.71428571;28.42857143;50.85714286;...
    30.71428571;26.42857143;42.71428571;47.85714286;49.28571429;47.42857143;...
    24.57142857;42;36.57142857;39.28571429;33.57142857;33.85714286;46.71428571;...
    26;46.85714286;64.71428571;85.42857143;65.57142857;34.85714286;36.57142857;...
    47.42857143;56.57142857;43;52.85714286;37.57142857;32;51.85714286;42.14285714;...
    63.57142857;52.14285714;57.57142857;66.57142857;56.71428571;75.71428571;...
    77.71428571;81.57142857;80;65.28571429;91.85714286;121.8571429;118;...
    83.28571429;71.71428571;36.28571429;45.85714286;71.42857143;77.57142857;...
    87.85714286;99.85714286;118;112.1428571;121.7142857;162.2857143;117.1428571;...
    99;105.8571429;76.57142857;62.57142857;58.14285714;73.71428571;62.42857143;...
    61.28571429;65.85714286;78.57142857;133.8571429;99.85714286;66.42857143;74;...
    69.71428571;79.28571429;73.85714286;95.28571429;49.28571429;50.85714286;...
    50.71428571;61.14285714;70.57142857;56.57142857;49;62.57142857;49.71428571;...
    57.57142857;59.57142857;100.5714286;93.85714286;77.57142857;106.4285714;...
    131.4285714;141.1428571];

y_inf_data_Pima=[128.0714286;116.4285714;70.57142857;42.28571429;62.57142857;...
    71.71428571;88.28571429;71.28571429;88.85714286;72.28571429;80.28571429;...
    106.4285714;137;82.28571429;91.85714286;77.28571429;81.57142857;82;80.42857143;...
    46.57142857;62;52.28571429;61;57.14285714;58.57142857;96;66;58.57142857;...
    71.28571429;75;148.1428571;115.7142857;112.8571429;146.2857143;114.1428571;...
    109.1428571;86.85714286;80.28571429;64.71428571;79.42857143;73.57142857;...
    79.57142857;73.28571429;75.85714286;55.71428571;68.14285714;60.71428571;...
    90;95.71428571;83.85714286;64.14285714;74.28571429;87.42857143;67;63.85714286;...
    105.4285714;75.85714286;58.14285714;82.42857143;128.5714286;146;90.42857143;...
    83.85714286;71.71428571;59.42857143;83.28571429;97.28571429;103.2857143;...
    87.71428571;76.28571429;76;75;62.71428571;85.71428571;111.8571429;127.5714286;...
    115.7142857;115.5714286;122;146.5714286;143;100.1428571;118.4285714;123.4285714;...
    131;101;110;92.57142857;82.57142857;102.8571429;122.2857143;125.2857143;...
    164.5714286;143.1428571;127.7142857;162.4285714;165.5714286;138.5714286;...
    138.2857143;140.7142857;88.14285714;110;104.5714286;117.7142857;84.28571429;...
    80.14285714;92.14285714;98.85714286;123.5714286;95.42857143;57.14285714;...
    83.85714286;83.57142857;112.2857143;113.8571429;139.7142857;100.5714286;...
    81.71428571;89.14285714;79;93.71428571;103.4285714;87.57142857;89;87.28571429;...
    100.5714286;104;109.4285714;115.2857143;93.42857143;113.4285714;132;134.5714286];

y_inf_data_AZ=[798.9142857;726.2857143;461.5714286;326;356.4285714;425;431.5714286;...
    431.4285714;463.7142857;401.1428571;489.7142857;682.1428571;696;564.8571429;...
    591.8571429;574;529.2857143;595;505.1428571;319.5714286;347.8571429;352.2857143;...
    325.7142857;338.8571429;435.5714286;410;380;432.5714286;517.4285714;471.7142857;...
    700.1428571;727.7142857;778.7142857;944.5714286;786.1428571;800;684;581.2857143;...
    464.1428571;574.4285714;529.1428571;459;454.8571429;483.2857143;495.4285714;...
    392.4285714;553;590;577;532.1428571;416;408.7142857;457.1428571;442.7142857;...
    417.2857143;522.8571429;522.2857143;444.8571429;643.4285714;953.8571429;...
    1184.714286;898.2857143;584.4285714;564.2857143;552;663;611;689.5714286;...
    609.8571429;538;622.7142857;523.4285714;630.4285714;745.5714286;658;811.4285714;...
    749.7142857;797.7142857;818.2857143;943.2857143;971;798.2857143;902.4285714;...
    1115.285714;1059;930;830;635.2857143;475.7142857;630.5714286;747.1428571;...
    800.2857143;1067.142857;1188.285714;1175.571429;1382.857143;1560.142857;...
    1323.285714;1113.428571;1147.285714;863.1428571;854.4285714;809;814.4285714;...
    810.7142857;736.7142857;842;1009.857143;1223.714286;952.8571429;673.5714286;...
    704.5714286;787;948.1428571;911.2857143;1072.571429;715.7142857;625.8571429;...
    617.1428571;691.2857143;759;704.4285714;615.2857143;773.5714286;702.4285714;...
    750.7142857;706;869.2857143;974.4285714;929.8571429;1126;1335;1417];

t_inf_data=[0;31;59;90;120;151;181;212;243;273;304;334;365;396;424;455;485;...
    516;546;577;608;638;669;699;730;761;789;820;850;881;911;942;973;1003;...
    1034;1064;1095;1126;1155;1186;1216;1247;1277;1308;1339;1369;1400;1430;...
    1461;1492;1520;1551;1581;1612;1642;1673;1704;1734;1765;1795;1826;1857;...
    1885;1916;1946;1977;2007;2038;2069;2099;2130;2160;2191;2222;2250;2281;...
    2311;2342;2372;2403;2434;2464;2495;2525;2556;2587;2616;2647;2677;2708;...
    2738;2769;2800;2830;2861;2891;2922;2953;2981;3012;3042;3073;3103;3134;...
    3165;3195;3226;3256;3287;3318;3346;3377;3407;3438;3468;3499;3530;3560;...
    3591;3621;3652;3683;3711;3742;3772;3803;3833;3864;3895;3925;3956;3986;4017];

y_inf_data=y_inf_data_Pinal;
y_pop_data=y_pop_data_Pinal;
alpha_h_b=alpha_h_pinal;
omega_b=omega_pinal;

%   Initial Conditions for the state variables  
%Initial Conditions

ic_D_M1=70;
ic_H_M1=200;%
ic_I_M1=y_inf_data(1);
ic_R_M1=ic_I_M1/2;
ic_S_M1=(y_pop_data(1)-ic_I_M1-ic_R_M1);
y0_M1=[ic_D_M1;ic_H_M1;ic_S_M1;ic_I_M1;ic_R_M1];

ic_O_M2=40;
ic_D_M2=70;
ic_H_M2=100;%
ic_A_M2=50;%100
ic_C_M2=10;
ic_I_M2=y_inf_data(1)/1;
ic_E_M2=ic_I_M2*1.5;%y_inf_data(1);
ic_R_M2=ic_I_M2/2;
ic_S_M2=(y_pop_data(1)-ic_I_M2-ic_E_M2-ic_R_M2);
y0_M2=[ic_O_M2;ic_D_M2;ic_H_M2;ic_A_M2;ic_C_M2;ic_S_M2;ic_E_M2;ic_I_M2;ic_R_M2];

ic_O_M3=40;
ic_D_M3=70;
ic_H_M3=100;%
ic_A_M3=50;%100
ic_C_M3=10;
ic_I_M3=y_inf_data(1)/1;
ic_E_M3=ic_I_M3*1.5;%y_inf_data(1);
ic_R_M3=ic_I_M3/2;
ic_S_M3=(y_pop_data(1)-ic_I_M3-ic_E_M3-ic_R_M3);
y0_M3=[ic_O_M3;ic_D_M3;ic_H_M3;ic_A_M3;ic_C_M3;ic_S_M3;ic_E_M3;ic_I_M3;ic_R_M3];

ic_V_M4=5000;
ic_O_M4=40;
ic_D_M4=70;
ic_H_M4=100;%
ic_A_M4=50;%100
ic_C_M4=10;
ic_I_M4=y_inf_data(1)/1;
ic_E_M4=ic_I_M4*1.5;%y_inf_data(1);
ic_R_M4=ic_I_M4/2;
ic_S_M4=(y_pop_data(1)-ic_I_M4-ic_E_M4-ic_R_M4);
y0_M4=[ic_V_M4;ic_O_M4;ic_D_M4;ic_H_M4;ic_A_M4;ic_C_M4;ic_S_M4;ic_E_M4;ic_I_M4;ic_R_M4];

ic_V_M5=5000;
ic_O_M5=40;
ic_D_M5=70;
ic_H_M5=100;%
ic_A_M5=50;%100
ic_C_M5=10;
ic_I_M5=y_inf_data(1)/1;
ic_E_M5=ic_I_M5*1.5;%y_inf_data(1);
ic_A_H_M5=y_inf_data(1);
ic_R_M5=ic_I_M5/2;
ic_S_M5=(y_pop_data(1)-ic_I_M5-ic_A_H_M5-ic_E_M5-ic_R_M5);
y0_M5=[ic_V_M5;ic_O_M5;ic_D_M5;ic_H_M5;ic_A_M5;ic_C_M5;ic_S_M5;ic_E_M5;ic_A_H_M5;ic_I_M5;ic_R_M5];

%   Parameter Vector  
% Model 1 params.
params_m1pswarm_AZ = [10.000000000000000; 0.090000000000000; 0.000000010000000; 450.000000000000000; 0.002688691728705; 0.061251562936845; 0.000000000000000; 0.000000035729237; 0.058375006001613; 0.003267090294530; 0.000000027768000];
params_m1pswarm_maricopa = [107.966058512893952; 0.000000010000000; 0.000000010000000; 362.402257489276849; 0.000280229097724; 0.050031440889300; 0.000000000000000; 0.000000054180839; 0.049996059143870; 0.071158515657904; 0.000359000000000];
 params_m1pswarm_pima = [109.397181039289094; 0.000000010000000; 0.000000010000000; 275.369005536686529; 0.000166003637744; 0.050089996409431; 0.000000000000000; 0.000000005519936; 0.050079364316579; 0.004789703380360; 0.000060194817064];
params_m1pswarm_pinal = [615.020259306903995; 0.059210035455996; 0.001546277844180; 406.861174352853652; 0.065903494684562; 0.049616351534628; 0.000000000000000; 0.000000009418913; 0.049562131752792; 0.046876827945816; 0.000180463922202];
 params_m1pswarm_rss_AZ = [10.000000000000000; 0.090000000000000; 0.000000010000000; 450.000000000000000; 0.002688690036923; 0.061251562936845; 0.000000000000000; 0.000000035729102; 0.058375006001613; 0.003267101330016; 0.000000027768000];
params_m1pswarm_rss_maricopa=[103.275195185716711; 0.000000010000000; 0.000000010000000; 368.365169341479202; 0.000232265038892; 0.050031440889300; 0.000000000000000; 0.000000022981806; 0.049996059105376; 0.003053759681333; 0.000000027768000];
%params_m1pswarm_rss_pima=
params_m1pswarm_rss_pinal = [103.482007522726107; 0.000000010000000; 0.000000010000000; 400.164725584392500; 0.000254982798741; 0.049616351534628; 0.000000000000000; 0.000000002552457; 0.049562159011018; 0.004818428624746; 0.000000027768000];

p_vec_M1 = zeros(11, 1);
% for i=1:11
%      p_vec_M1(i)=(params_m1pswarm_AZ(i)+params_m1pswarm_maricopa(i)+params_m1pswarm_pima(i)+params_m1pswarm_pinal(i)+...
%                 params_m1pswarm_rss_AZ(i)+params_m1pswarm_rss_maricopa(i)+params_m1pswarm_rss_pinal(i))/7;
% end
%  p_vec_M1(1) =O*delta_O or just O 
% p_vec_M1(2) =mu_H
% p_vec_M1(3) = gamma_H
% p_vec_M1(4) = H_max
% p_vec_M1(5) =delta_H
% p_vec_M1(6) = alpha_h
% p_vec_M1(7) =delta_R
% p_vec_M1(8) = epsilon
% p_vec_M1(9) = omega
% p_vec_M1(10) = rho
% p_vec_M1(11) = kappa

%p_vec_M1=params_m1pswarm_AZ;
% p_vec_M1= params_m1pswarm_maricopa;
 %p_vec_M1=params_m1pswarm_pima;
% p_vec_M1=params_m1pswarm_pinal;



% Model 2 params.
params_m2pswarm_AZ = [5.009606620067531; 0.434798441239070; 0.089732287736925; 0.000026255026616; 377.699911269605366; 0.199999919194991; 0.026685897897313; 0.002937147058955; 0.000000361032194; 0.000829456046382; 0.061251562936845; 0.000000103246512; 0.058374942666625; 0.001377500774935; 0.000000027768000; 0.120779967337124];
params_m2pswarm_maricopa = [1999.998994242816025; 0.000252946061599; 0.000474844922769; 0.000000010000000; 250.000000000000000; 0.000001000000000; 0.016621402067285; 0.060000000000000; 0.000001000000000; 0.000296114264124; 0.050031440889300; 0.000000280335282; 0.049996059143870; 0.023434241099017; 0.000359000000000; 0.129551958597833];
params_m2pswarm_pima = [5.000000000000000; 0.000000001000000; 0.000009036430485; 0.009583452249398; 307.683245664926801; 0.000001258961163; 0.029052133876465; 0.031974350777597; 0.000000018054436; 0.000394979870026; 0.050089996409431; 0.000000020917158; 0.050079317535948; 0.002135911184399; 0.000212286205543; 0.116648951361555];
params_m2pswarm_pinal = [191.369865282661578; 0.184675455829919; 0.084791977025996; 0.056968986220313; 383.382880762631714; 0.100469052001126; 0.000070291115559; 0.000011696396393; 0.000000000100000; 0.001000000000000; 0.049616351534628; 0.000000118293362; 0.049562104492649; 0.001369863013699; 0.000359000000000; 0.082064617605216];
params_m2pswarm_rss_AZ = [2000.000000000000000; 0.081021348802146; 0.004614796441427; 0.000000010000000; 313.283411072767933; 0.046762751586737; 0.005150708404564; 0.002973964970661; 0.000000573816053; 0.000843304697541; 0.061251562936845; 0.000000487624958; 0.058375000783840; 0.055052454947719; 0.000359000000000; 0.021965323913234];
params_m2pswarm_rss_maricopa = [5.000000000000000; 0.499929905347587; 0.000002303897136; 0.000000014151561; 250.000003918414308; 0.000001000000000; 0.009565658708594; 0.059999910067560; 0.000001000000000; 0.000000113100782; 0.050031440889300; 0.000002292464795; 0.049996059143870; 0.071428563013282; 0.000359000000000; 0.016666667234204];
params_m2pswarm_rss_pima = [2000.000000000000000; 0.000252626846328; 0.000400569077468; 0.000000010000000; 450.000000000000000; 0.000344314890444; 0.016125844723088; 0.060000000000000; 0.000000013560434; 0.000459152337528; 0.050089996409431; 0.000000486978371; 0.050079348014773; 0.071020416540931; 0.000000027768000; 0.141047903954612];
params_m2pswarm_rss_pinal = [1368.510054274074491; 0.074766333048293; 0.065888653043561; 0.011135598773992; 272.247114455621215; 0.200000000000000; 0.000109958728497; 0.000043952244284; 0.000000277347229; 0.001000000000000; 0.049616351534628; 0.000000104532250; 0.049562159011018; 0.004934788262773; 0.000352914764756; 0.141977440743225]; 

% p_vec_M2 = zeros(16, 1);
% p_vec_M2=params_m2pswarm_AZ;
%p_vec_M2=params_m2pswarm_maricopa;
%p_vec_M2=params_m2pswarm_pima;
%p_vec_M2=params_m2pswarm_pinal;
% for i=1:11
%      p_vec_M2(i)=(params_m2pswarm_AZ(i)+params_m2pswarm_maricopa(i)+params_m2pswarm_pima(i)+params_m2pswarm_pinal(i)+...
%                 params_m2pswarm_rss_AZ(i)+params_m2pswarm_rss_maricopa(i)+params_m2pswarm_rss_pima(i)+params_m2pswarm_rss_pinal(i))/8;
% end
% p_vec_M2=params_m2pswarm_pima;


% Model 3 params.
params_m3pswarm_AZ = [1.000091238101880; 0.224913418537232; 0.042400800996107; 0.005342167652016; 420.024105476013915; 0.048552820880670; 0.001656995921495; 0.003088977619667; 0.000003171636621; 0.000998368187960; 84.974081417980031; 78.728106477423751; 11.486916832447497; 7.000000000000000; 56.497988291979595; 699.858791619708200; 31.699614913962755; 200.000000000000000; 30.022617901139860; 10.230735164639995; 1.375695927349896; 1.023354184898401; 6.935298536082342; 0.061251562936845; 0.000000192032348; 0.058375058539113; 0.019540898899007; 0.000271579407899; 0.134116739044291];
params_m3pswarm_maricopa = [];
params_m3pswarm_pima =[1.001958584897151; 0.051042432222074; 0.026979111466328; 0.003923177834857; 420.559374505995152; 0.011081410714083; 0.098729412596656; 0.000453986029834; 0.000100000000000; 0.000192628405566; 70.000000000000000; 78.601456362136503; 12.769850408294619; 9.760981912713550; 57.755236872837706; 215.670293705046277; 30.063529194531188; 699.945885944297629; 30.060984278977333; 1.000001911363284; 0.100000000000000; 1.000000000000000; 0.100140601152242; 0.050089996409431; 0.000000094890335; 0.050079409322391; 0.002739726027397; 0.000339157359695; 0.089588358839410]; 
params_m3pswarm_pinal = [];
params_m3pswarm_rss_AZ = [2000.000000000000000; 0.081021348802146; 0.004614796441427; 0.000000010000000; 313.283411072767933; 0.046762751586737; 0.005150708404564; 0.002973964970661; 0.000000573816053; 0.000843304697541; 0.061251562936845; 0.000000487624958; 0.058375000783840; 0.055052454947719; 0.000359000000000; 0.021965323913234];
params_m3pswarm_rss_maricopa = [5.000000000000000; 0.499929905347587; 0.000002303897136; 0.000000014151561; 250.000003918414308; 0.000001000000000; 0.009565658708594; 0.059999910067560; 0.000001000000000; 0.000000113100782; 0.050031440889300; 0.000002292464795; 0.049996059143870; 0.071428563013282; 0.000359000000000; 0.016666667234204];
params_m3pswarm_rss_pima = [2000.000000000000000; 0.000252626846328; 0.000400569077468; 0.000000010000000; 450.000000000000000; 0.000344314890444; 0.016125844723088; 0.060000000000000; 0.000000013560434; 0.000459152337528; 0.050089996409431; 0.000000486978371; 0.050079348014773; 0.071020416540931; 0.000000027768000; 0.141047903954612];
params_m3pswarm_rss_pinal = [1368.510054274074491; 0.074766333048293; 0.065888653043561; 0.011135598773992; 272.247114455621215; 0.200000000000000; 0.000109958728497; 0.000043952244284; 0.000000277347229; 0.001000000000000; 0.049616351534628; 0.000000104532250; 0.049562159011018; 0.004934788262773; 0.000352914764756; 0.141977440743225]; 

p_vec_M3 = zeros(29, 1);
% for i=1:11
%      p_vec_M3(i)=(params_m3pswarm_AZ(i)+params_m3pswarm_maricopa(i)+params_m3pswarm_pima(i)+params_m3pswarm_pinal(i)+...
%                 params_m3pswarm_rss_AZ(i)+params_m3pswarm_rss_maricopa(i)+params_m3pswarm_rss_pima(i)+params_m3pswarm_rss_pinal(i))/8;
% end
p_vec_M3=params_m3pswarm_AZ;
%p_vec_M3=params_m3pswarm_maricopa;
%p_vec_M3=params_m3pswarm_pima;
%p_vec_M3=params_m3pswarm_pinal;

% Model 4 params.
params_m4pswarm_AZ = [];
params_m4pswarm_maricopa = [0.000010000000000; 0.100000000000000; 0.009966864510448; 201.225612482564628; 0.007792528427811; 0.023950497037501; 0.002593893807706; 0.000000010000000; 0.000000103015383; 79.684809059824147; 90.000000000000000; 12.261639500423215; 9.772284389420793; 70.000000000000000; 488.155996459108110; 99.318900482000188; 217.336654881775843; 149.974884412188800; 19.969250295208315; 0.102229127750650; 2.217953146581862; 3.346218700664260; 75.000000000000000; 0.026075481232795; 0.010141847192760; 0.000000000002248; 65.001212802818813; 0.000009999992753; 7.175129812875232; 31.000000000000000; 19.970847084426751; 0.050031440889300; 0.000000000000000; 0.000000120397558; 0.049996104140319; 0.001369863013699; 0.000002092853757; 0.045002038482630]; 
params_m4pswarm_pima = [];
params_m4pswarm_pinal = [];
params_m4pswarm_rss_AZ = [];
params_m4pswarm_rss_maricopa=[];
%params_m1pswarm_rss_pima=
params_m4pswarm_rss_pinal = [];

p_vec_M4 = zeros(38, 1);
% for i=1:11
%      p_vec_M4(i)=(params_m4pswarm_AZ(i)+params_m4pswarm_maricopa(i)+params_m4pswarm_pima(i)+params_m4pswarm_pinal(i)+...
%                 params_m4pswarm_rss_AZ(i)+params_m4pswarm_rss_maricopa(i)+params_m4pswarm_rss_pinal(i))/7;
% end
p_vec_M4 = params_m4pswarm_maricopa;
% 

%Model 5 params.
params_m5pswarm_AZ = [0.059666039475293; 1.500000000000000; 56.159676367528043; 0.083324561876196; 0.001071128181719; 251.043272507251231; 0.038467227364723; 0.000307339890048; 0.003458821692034; 0.000000909560967; 0.000118658789881; 79.623388236315577; 80.875730227330436; 12.815115427521537; 9.668902757394513; 600.000000000000000; 78.846512885914464; 411.879715104253080; 77.014429908153815; 15.612823451643191; 6.117954156767697; 11.849000119033166; 0.111319764863660; 79.824736842352536; 0.029206812832168; 0.006562653165126; 0.000000000011563; 74.940377446107533; 0.000000922100719; 6.488857921114797; 95.000000000000000; 1.001258627809564; 0.061251562936845; 0.000000143905641; 0.058374952754485; 0.002500000000000; 0.000359000000000; 0.124306798546976];
params_m5pswarm_maricopa = [0.013570881517425; 3.486114778821585; 71.406523778789293; 0.026463109731532; 0.009991594012416; 250.168964486127066; 0.006768187939550; 0.014336448312723; 0.003875647947497; 0.000000254669175; 0.000628423005189; 82.998323072617339; 85.492406059282430; 12.999717238074208; 7.874232437595512; 600.000000000000000; 77.952271528502479; 549.070017687924860; 80.000000000000000; 5.294916732113520; 5.669890993717204; 5.000174208490977; 5.004743929127285; 82.996474120536789; 0.000100000000000; 0.000155519428524; 0.000000000010811; 65.055263049055469; 0.000000121532291; 6.999810033504946; 95.000000000000000; 10.000000000000000; 0.050031440889300; 0.000000100352435; 0.049996103209800; 0.002547901582564; 0.000000027768000; 0.098069080146065]; 
params_m5pswarm_pima = [0.048225552093831; 3.498680547158601; 80.000000000000000; 0.014128398686701; 0.000002254662011; 360.000000000000000; 0.017306540718082; 0.043676816987336; 0.001403399151341; 0.000001000000000; 0.000242781986754; 77.675156368739394; 81.176312775207492; 12.246075847950394; 8.672455834883079; 300.000000000000000; 50.308740170172761; 377.390710316257241; 80.000000000000000; 15.689220086247433; 5.781445734880267; 5.000000000000000; 0.100000000000000; 78.012080812738560; 0.000897710479038; 0.000402841576667; 0.000000000010000; 68.309708046942660; 0.000007695068597; 5.515944291236175; 95.000000000000000; 10.000000000000000; 0.050089996409431; 0.000000100024105; 0.050079310171154; 0.010060627847230; 0.000358961627659; 0.134355916594832];
params_m5pswarm_pinal = [0.025281851966274; 3.498741290809847; 79.199946050010382; 0.007746440410439; 0.010000000000000; 359.737522197820510; 0.012895828676164; 0.022565486769813; 0.004452937453360; 0.000001000000000; 0.000357022346615; 75.264693098549486; 81.970423040381505; 12.999997807406544; 7.000000000000000; 600.000000000000000; 50.155049035487920; 599.929271610498631; 80.000000000000000; 5.000000000000000; 7.998526440122907; 5.000000000000000; 7.000000000000000; 81.460545712911554; 0.000305320445468; 0.000191253652746; 0.000000000037791; 74.273410056343963; 0.000000051307662; 5.698152366876352; 95.000000000000000; 9.997754040585503; 0.049616351534628; 0.000000137804356; 0.049562127905983; 0.002553168850162; 0.000033471870145; 0.037724197591789];

p_vec_M5 = params_m5pswarm_pinal;

%Time Span for Simulation
tspan = [0 4017];

%% 2: Config/Run Sensitivity Analysis
% 


fprintf('Configuring and running Forward Sensitivity Analysis...\n');

%: Create and configure ode 
F = ode;
F.ODEFcn = @M5_SF; 
%F.ODEFcn = @M4_SF_S;         % Assign ODE function
%F.ODEFcn = @M3_SF;
%F.ODEFcn = @M2_SF;
%F.ODEFcn = @M1_SF_T;
F.InitialValue = y0_M5;        % Assign ICs
F.Parameters = p_vec_M5;       % Assign parameter values
p_vec=p_vec_M5;
% 2: Enable Forward Sensitivity Analysis 
F.Sensitivity = odeSensitivity;

%3: Solve the augmented system 
sol = solve(F, tspan(1), tspan(2));

fprintf('Analysis complete. Processing results...\n');

%%  3: Process and Visualize Results
% 
% This section extracts the solution and sensitivity data, calculates the
% normalized sensitivities, and creates plots.

%Extract Results from  'sol' 
time_vec = sol.Time;
y_sol = sol.Solution;           % Solution matrix: 10 states (rows) x N_time (cols)
sens_raw = sol.Sensitivity;     % Raw sensitivity array: 10 states x 38 params x N_time

%Plot the Model Dynamics 
state_names_M1 = {'D', 'H', 'S', 'I', 'R'};
state_names_M2 = {'O', 'D', 'H', 'A', 'C', 'S', 'E', 'I', 'R'}; 
state_names_M3 = {'O', 'D', 'H', 'A', 'C', 'S', 'E', 'I', 'R'};
state_names_M4 = {'V', 'O', 'D', 'H', 'A', 'C', 'S', 'E', 'I', 'R'};
state_names_M5 = {'V', 'O', 'D', 'H', 'A', 'C', 'S', 'E', 'A_H', 'I', 'R'};
state_names=state_names_M5;
figure('Name', 'Model State Dynamics');
plot(time_vec, y_sol, 'LineWidth', 2);
title('Dynamics of Model States Over Time');
xlabel('Time (days)');
ylabel('State Value');
legend(state_names, 'Location', 'best');
grid on;
axis tight;

% Calculate Normalized Sensitivities 
% Formula: S_norm = (dy/dp) * (p/y)
num_states = size(y_sol, 1);
num_params = length(p_vec);
sens_norm = zeros(size(sens_raw)); % Pre-allocate for speed

for i = 1:num_states
    for j = 1:num_params
        raw_ij = squeeze(sens_raw(i, j, :));
        state_i_series = y_sol(i, :);
        param_j_val = p_vec(j);
        sens_norm(i, j, :) = raw_ij'.* (param_j_val./ (state_i_series + eps));
    end
end


%  Visualize a Subset of Normalized Sensitivities 

state_to_plot_idx = 10;            %m1=4, m2=8 ,m3=8, m4=9, m5=10
params_to_plot_idx = num_params; 
% Define names for parameters 
param_names_M5 = {'k_{ref}','Q_{10}','T_{ref}', '\mu_H', '\gamma_H', 'H_{max}', '\delta_H',...
    '\gamma_A', '\delta_A', '\phi_A', '\delta_C', 'T_{opt,H}', 'T_{opt,A}',...
    'S_{opt,H}', 'S_{opt,A}', 'bl_{Top,A}', 'ab_{Top,A}',...
    'bl_{Top,H}', 'ab_{Top,H}', 'bl_{Sop,A}', 'ab_{Sop,A}',...
    'bl_{Sop,H}', 'ab_{Sop,H}', 'T_{hs}', '\beta', '\delta_V', '\sigma',...
    'T_{cs}', '\alpha', 'S_{d,s}', 'T_{d,s}', 'xtr_{c,s}', '\alpha_h',...
    '\epsilon', '\omega', '\rho', '\kappa', '\psi'};     
param_names_M4 = {'\delta_O', '\mu_H', '\gamma_H', 'H_{max}', '\delta_H',...
    '\gamma_A', '\delta_A', '\phi_A', '\delta_C', 'T_{opt,H}', 'T_{opt,A}',...
    'S_{opt,H}', 'S_{opt,A}', 'T_{decay}', 'bl_{Top,A}', 'ab_{Top,A}',...
    'bl_{Top,H}', 'ab_{Top,H}', 'bl_{Sop,A}', 'ab_{Sop,A}',...
    'bl_{Sop,H}', 'ab_{Sop,H}', 'T_{hs}', '\beta', '\delta_V', '\sigma',...
    'T_{cs}', '\alpha', 'S_{d,s}', 'T_{d,s}', 'xtr_{c,s}', '\alpha_h',...
    '\delta_R', '\epsilon', '\omega', '\rho', '\kappa', '\psi'};
param_names_M3={'\Pi','\delta_O', '\mu_H', '\gamma_H', 'H_{max}', '\delta_H',...
    '\gamma_A', '\delta_A', '\phi_A', '\delta_C', 'T_{opt,H}', 'T_{opt,A}',...
    'S_{opt,H}', 'S_{opt,A}', 'T_{decay}', 'bl_{Topt,A}', 'ab_{Topt,A}',...
    'bl_{Topt,H}', 'ab_{Topt,H}', 'bl_{Sopt,A}', 'ab_{Sopt,A}',...
    'bl_{Sopt,H}', 'ab_{Sopt,H}', '\alpha_h','\epsilon', '\omega', '\rho', '\kappa', '\psi'};
param_names_M2={'\Pi','\delta_O','\mu_H','\gamma_H','H_{max}','\delta_H','\gamma_A',...
    '\delta_A','\phi_A','\delta_C','\alpha_h','\epsilon','\omega','\rho','\kappa','\psi'};
param_names_M1={'\delta_O','\mu_H', '\gamma_H', 'H_{max}', '\delta_H', ...
    '\alpha_h','\delta_R', '\epsilon', '\omega', '\rho', '\kappa'};
param_names=param_names_M5;

figure('Name', 'Subset of Normalized Sensitivities');
sgtitle(sprintf('Normalized Sensitivity of State ''%s'' to Selected Parameters', state_names{state_to_plot_idx}), 'FontSize', 16, 'FontWeight', 'bold');

tl = tiledlayout('flow', 'TileSpacing', 'compact', 'Padding', 'compact');
for j = params_to_plot_idx
    nexttile;
    plot(time_vec, squeeze(sens_norm(state_to_plot_idx, j, :)), 'LineWidth', 2);
    title(sprintf('Parameter: %s', param_names{j}), 'Interpreter', 'tex');
    grid on;
    xlabel('Time (days)');
    ylabel('Normalized Sensitivity');
end

fprintf('Visualization complete.\n');

%% 4 : Bar Graph for State 'I' Sensitivity
% calculates the integrated normalized sensitivity for each parameter's effect on I and plots results
fprintf('Creating colored sensitivity bar graph for State ''I''...\n');

% Define the state of interest
state_I_idx = 10;   %m1=4, m2=8 ,m3=8, m4=9, m5=10
state_name_for_title = 'I';

% Calculate Integrated Absolute Normalized Sensitivity for I
num_params = length(p_vec);
sensitivity_for_I = zeros(num_params, 1);

% Loop through each parameter
for j = 1:num_params
    % Extract the normalized sensitivity vector for State 'I'
    Sj_norm_for_I = squeeze(sens_norm(state_I_idx, j, :));
    
    % Handle any potential NaN or Inf values from normalization
    Sj_norm_for_I(isnan(Sj_norm_for_I) | isinf(Sj_norm_for_I)) = 0;

    % Integrate the absolute normalized sensitivity over time.
    sensitivity_for_I(j) = trapz(time_vec, abs(Sj_norm_for_I));
end
% M1_sens_AZ= [20.602943957892826; 14.852102873398163; 20.587994694782456; 0.018739360416023; 21399.997772424350842; 490403.203511981351767; 0.000000000000000; 4000.745158918165998; 471149.014738673111424; 211.369513434666800; 0.001800817736415];
% M1_sens_maricopa=[893.325124761833194; 1.576249154776752; 893.977309199237425; 2453.969411006958580; 670.057301584442143; 402016.670380931231193; 0.000000000000000; 4004.609037080517737; 403277.709889030782506; 2345.432310835205499; 12.124885447083125];
% M1_sens_pima=[462.919800162482204; 0.770551410151212; 463.243462272724742; 2618.762329460980254; 352.098482097167050; 400468.644141210359521; 0.000000000000000; 3977.161251480203191; 404051.429686414252501; 350.805418065707499; 4.419497961624881];
% M1_sens_pinal=[2492.838313652298439; 2492.838341721584129; 2492.860144365776705; 1494.271657873862068; 2494.610267820520676; 398244.821221809776034; 0.000000000000000; 3991.726789545270549; 399875.602027940331027; 1954.150656536646466; 7.545211613108054];
% M1_sens_mean=(M1_sens_AZ+M1_sens_maricopa+M1_sens_pima+M1_sens_pinal)/4;
% M2_sens_AZ=[2502.327868587756711; 0.216226348458006; 1114.944965924975122; 2504.000896737053608; 1.403954668500707; 2956.769529983187567; 1731.992374840337789; 18040.739056040416472; 2.524294262017013; 5250.487204854767697; 488722.743544351076707; 3981.711312834489945; 470986.868859293696005; 92.311297433343498; 0.001863643839938; 1308.948074841749985];
% M2_sens_maricopa=[870.947422326457740; 725.021752720257496; 856.552274132942330; 871.128607145488559; 1222.273138586262803; 4.361941772935818; 3950.399183046120925; 3948.729346920083117; 2.861414062016744; 374.599875885100232; 399816.605230007611681; 3966.679676844215919; 403378.582107002614066; 1271.498473586715136; 19.771214513321222; 1136.299508514586250];
% M2_sens_pima=[0.086857071632811; 0.087112568248444; 3.598872994267187; 0.743426002882896; 3949.652022959197438; 1.385882424054977; 3953.449005797757309; 3926.440298862946747; 0.000000206899751; 0.608444848669521; 399091.845301410998218; 3958.705489546709032; 404045.880608295381535; 163.321253820310091; 16.363697420499417; 1212.655168815816523];
% M2_sens_pinal=[194.588774567630310; 0.585510873674238; 195.065397026008753; 195.099155345513935; 1563.227227097736886; 194.893243501414133; 1758.437761319627498; 69.267511840892183; 0.000373070096776; 359.972500995593691; 394932.738173062505666; 3947.188799287894199; 399874.232010002131574; 106.561813677823338; 28.258331843665690; 1530.106421015334490];
% M2_sens_mean=(M2_sens_AZ+M2_sens_maricopa+M2_sens_pima+M2_sens_pinal)/4;
% M3_sens_AZ=[2682.471377572825077; 2.517131078884178; 1444.633948423030233; 2682.315384935273414; 52.892806550294964; 4576.866453985297994; 1499.450194528048542; 14110.664295393464272; 19.971697524893138; 6576.089716590930038; 26670.476023953109689; 4730.718103620384682; 21098.814237798796967; 16790.526264686777722; 2.517229494464535; 220.279792443232907; 122.679139106357027; 2359.157729620269492; 0.000000000006414; 5.331859351834908; 2003.392762663719623; 732.488332327279863; 51.080944218503873; 489798.343200267408974; 3992.776633496476734; 470992.519702897581737; 999.826444754711929; 13.924860724176968; 1219.668040873136533];
% M3_sens_maricopa=;
% M3_sens_pima=[817.030881590398849; 36.702404254822738; 1853.732865514546347; 817.324910149268817; 251.422471398102886; 3032.157163372271043; 2899.723955692413256; 2105.591553421103526; 379.017558311951916; 153.789635351739889; 5085.559955782086035; 11211.507309172118767; 12133.708713170690316; 24276.576946152141318; 36.702363829379223; 2994.407748859349340; 484.425660690951986; 221.099297478353776; 229.079060646726759; 1695.667856524271428; 687.288927333363290; 1049.265102109905001; 40.528107009481545; 398931.303825252805836; 3975.864112801414194; 404048.739450234686956; 206.357932269880109; 25.774939255248803; 1437.317208227151241];
% M3_sens_pinal=
% M3_sens_mean=(M3_sens_AZ+M3_sens_pima)/2;
% M3_sens_mean=(M3_sens_AZ+M3_sens_maricopa+M3_sens_pima+M3_sens_pinal)/4;
% M4_sens_AZ=;
% M4_sens_maricopa=[2168.198824807018354; 2230.407727720614275; 2211.652285217178360; 1687.014715104058723; 4111.656111839474761; 4912.715461813788352; 4296.947302377981032; 0.004230193451670; 0.339812621368539; 7257.535920692365835; 16820.410823800557409; 24471.027511422329553; 14963.316338986611299; 2168.198809732888549; 2287.316974065618524; 46.398522182600104; 507.658801447651967; 734.761341980569341; 407.281699984520060; 293.620152160986891; 2126.147273853509432; 186.172661527003243; 30284.276367708203907; 6331.540807406548083; 8325.270617079297153; 0.000011126686862; 44103.486123164511810; 2166.899740713124629; 8558.127418531386866; 0.000000000000000; 106.599489365860350; 397673.004788346588612; 0.000000000000000; 3971.263723201187531; 403375.102293159754481; 106.609076385283885; 0.164577211825165; 2108.540314921066056];
% M4_sens_pima;
% M4_sens_pinal=
% M4_sens_mean=(M4_sens_AZ+M4_sens_maricopa+M4_sens_pima+M4_sens_pinal)/4;
M5_sens_AZ=[92.824400939301157; 113.826801048005422; 117.441725748305799; 2235.526018958784334; 2579.201626439940355; 443.717467120828132; 2200.948439056603092; 2567.633819745608889; 13803.168341565267838; 0.800971495035465; 715.486838454739427; 4790.176966943507068; 3772.158952933302317; 10288.542744269054310; 3071.506159220958580; 427.409734162714813; 8.535609043632965; 660.508997383040537; 28.015878914297794; 145.498490768279680; 357.420505180468581; 930.171913285643996; 5.941360081638985; 531846.295478405896574; 24772.345825114844047; 37503.339310801777174; 0.000004479266311; 271719.486531014728826; 1968.773130721133839; 65.766782550818434; 0.000000000000000; 8.060179826089332; 488840.062336250499357; 4025.243873291031377; 470973.504687183769420; 163.144439784732981; 23.463588310848998; 1249.983623439118674];
M5_sens_maricopa=[227.883519300890100; 238.265585546945857; 1128.930108569755248; 3098.266532152062155; 3074.634824328817103; 2539.880709739392387; 4428.700375772003099; 6159.186603169746377; 5977.963439192740225; 1.130397021470081; 1281.011268021124124; 12196.387300060983762; 6831.091306975830776; 31950.933714104670798; 14976.745781056586566; 1999.733445412453420; 552.376324219371440; 740.760628430588440; 728.274386808195231; 38.142992564070916; 1771.660236597289213; 4013.914040035756443; 124.215384916833585; 948.840603114380428; 233.968035119393761; 1873.540222178766271; 0.000212515364556; 1018.448409187317225; 2364.414623858855975; 3134.239960443041127; 0.000000000000000; 10.545239131547504; 398385.766640907851979; 4335.498893122554364; 403377.411514462961350; 194.075440096403838; 0.002136214155035; 1073.808017667769946];
M5_sens_pima=[392.082726653368809; 766.389205454850298; 2182.393208086205050; 4079.848644802133549; 3018.506606550067318; 202.666901512982264; 5138.345378180004445; 5637.534360953904070; 5134.128208349986380; 0.099936538653506; 621.585663901861608; 20499.130354298442398; 11676.267439932335037; 16574.022697405052895; 12655.702227454039530; 1972.521630686468825; 711.645974772654313; 134.154945517530535; 958.237200684844424; 89.970875583000861; 1641.749426026359743; 1125.846348994972232; 11.594385679047287; 9040.965335123488330; 1165.663414841695158; 917.401869501776105; 0.000057239819837; 10658.360055690165609; 3006.643488260449431; 0.000000000000000; 0.000000000000000; 0.000000000000000; 399656.284170662809629; 4230.827221853958690; 404044.070819517248310; 666.616286158848993; 24.018971471132751; 865.772644953629424];
M5_sens_pinal=[371.230903921728952; 800.392243426817686; 2045.688632548791247; 3909.646817361187459; 3774.482696265688446; 2715.749120767950444; 5962.333574846281408; 6780.501468445974751; 6615.225980533438815; 10.473687460443575; 1067.762969829178928; 23673.025305048777227; 11596.882434729350280; 42984.254931664661854; 21349.046615425388154; 2381.366771559332392; 955.460910985155124; 859.048621128268906; 2012.594617372220682; 1.660398682255852; 3848.821249005775371; 5200.534609321229254; 42.009819742949958; 3486.494331596919892; 260.984553107481929; 2066.855283041208168; 0.000930639783317; 2648.640237753493238; 2269.782199928149566; 0.000000000000000; 0.000000000000000; 0.000000000000000; 393705.532372475310694; 4967.368108571319681; 399874.509887119173072; 195.413406019742666; 2.587107932595377; 1806.409139798591241];
M5_sens_mean=(M5_sens_AZ+M5_sens_maricopa+M5_sens_pima+M5_sens_pinal)/4;
fprintf('sensitivity_for_I = [%s%.15f];\n', sprintf('%.15f; ', sensitivity_for_I(1:end-1),sensitivity_for_I(end)),'\n',' ');

%  Sort Results for Better Visualization 
[sorted_sensitivity_I, sort_idx_I] = sort(M5_sens_mean, 'descend');
%[sorted_sensitivity_I, sort_idx_I] = sort(sensitivity_for_I, 'descend');
sorted_param_names_I = param_names(sort_idx_I);

%  Create the Bar Graph with Different Colors 
figure('Name', 'Normalized Parameter Sensitivity Ranking for State I');

num_bars = length(sorted_sensitivity_I);
colors = hsv(num_bars); % Generate a set of distinct colors

hold on; 
for i = 1+2:num_bars  %add 2 to 1 to skip first 2
    % Plot each bar individually and set its 'FaceColor'
    bar(i, sorted_sensitivity_I(i), 'FaceColor', colors(i,:));
end
hold off;

%Add Labels
title(sprintf("Model 5 Normalized Parameter Sensitivity for State %s", state_name_for_title), 'FontSize', 24);
ylabel({'Integrated Absolute Normalized Sensitivity'}, 'FontSize', 20);
xlabel('Model Parameters', 'FontSize', 20);
grid on;
axis tight;

ax = gca; % Get handle to current axes
sorted_param_names_I=sorted_param_names_I(3:end);
ax.XTick = 1+2:num_params;  %add 2 to 1 to skip first 2
ax.XTickLabel = sorted_param_names_I;
ax.XTickLabelRotation = 0;
ax.XAxis.FontSize = 10; 

ax.YAxis.FontSize = 8;

fprintf('Colored bar graph for State I created successfully.\n');


%%  5 : 0-1 Scaled Bar Graph for I

fprintf('Creating 0-1 scaled and colored bar graph for ''I''...\n');

% Scale the Sorted Sensitivity Values to a 0-1 Range 
scaled_sensitivity_I = sorted_sensitivity_I / max(sorted_sensitivity_I);

%  Create the Bar Graph with Different Colors
figure('Name', 'Relative Parameter Sensitivity for State I (Scaled & Colored)');

num_bars = length(scaled_sensitivity_I);
colors = parula(num_bars); % Generate a set of distinct colors

hold on; % Hold the plot to draw multiple bars
for i = 1:num_bars
    % Plot each bar individually and set its 'FaceColor'
    bar(i, scaled_sensitivity_I(i), 'FaceColor', colors(i,:));
end
hold off; % Release the plot

% Add  Labels  
title(sprintf('Relative Parameter Sensitivity for State ''%s''', state_name_for_title), 'FontSize', 16);
ylabel('Relative Integrated Sensitivity (Scaled to Max = 1)', 'FontSize', 12);
xlabel('Model Parameters', 'FontSize', 12);
grid on;
ylim([0 1.05]); % Set y-axis limit to just above 1.0

set(gca, 'XTick', 1:num_params, 'XTickLabel', sorted_param_names_I);
set(gca, 'XTickLabelRotation', 90); % Rotates the labels

fprintf('Scaled and colored bar graph for State I created successfully.\n');


%% 6: Find Max Percent-for-Percent Sensitivity
% What is the maximum percentage change in I that can be caused by a 1% change in each parameter at any single point in time?"

fprintf('Calculating maximum sensitivities for ''I''...\n');

%   Define the state of interest  
% For your M1 model, y0_M1=[D; H; S; I; R], %m1=4, m2=8 ,m3=8, m4=9, m5=10
state_I_idx = 4;
state_name_for_title = 'I';
num_params = length(p_vec);

%   Find the Maximum Absolute Normalized Sensitivity for State 'I'  
max_percent_sensitivity = zeros(num_params, 1);

% Loop through each parameter
for j = 1:num_params
    % Extract the normalized sensitivity vector for State 'I'
    Sj_norm_for_I = squeeze(sens_norm(state_I_idx, j, :));
    
    % Handle any potential NaN or Inf values from normalization
    Sj_norm_for_I(isnan(Sj_norm_for_I) | isinf(Sj_norm_for_I)) = 0;

    % Find the peak absolute value in the time series
    max_percent_sensitivity(j) = max(abs(Sj_norm_for_I));
end

% Sort Results  
[sorted_max_sens, sort_idx_max] = sort(max_percent_sensitivity, 'descend');
sorted_param_names_max = param_names(sort_idx_max);

%  Display in a Table 
fprintf('\n  Maximum Sensitivity Results for State ''%s''  \n', state_name_for_title);
fprintf('This table shows the maximum percent change in the state for a 1%% change in the parameter.\n\n');
results_table = array2table(sorted_max_sens*100, 'RowNames', sorted_param_names_max, 'VariableNames', {'Max_Impact_Percent'});
disp(results_table);


% Bar Graph of Max Values  
figure('Name', 'Maximum Percent-for-Percent Sensitivity');
bar(sorted_max_sens);
title(sprintf('Maximum %% Change in State ''%s'' for a 1%% Parameter Change', state_name_for_title));
ylabel('Maximum Absolute Normalized Sensitivity');
xlabel('Model Parameters');
grid on;
set(gca, 'XTick', 1:num_params, 'XTickLabel', sorted_param_names_max, 'XTickLabelRotation', 90);



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%MODEL 1 Function
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%Model 1 function  
function dM1_SF_T = M1_SF_T(t,a,params)
D = a(1); H = a(2); S=a(3); I=a(4); R=a(5); 

O=params(1);  mu_H=params(2);
gamma_H=params(3); H_max=params(4); delta_H=params(5);
alpha_h=params(6);      delta_R=params(7);
epsilon=params(8);     omega=params(9);        rho=params(10);
kappa=params(11);   

dD=O-mu_H*D*H;
dH=gamma_H*D*H*(1-(H/H_max))-delta_H*H;

dS=alpha_h*(S+I+R)+delta_R*R-epsilon*S*H-omega*S;
dI=epsilon*S*H-rho*I-kappa*I-omega*I;
dR=rho*I-delta_R*R-omega*R;


dM1_SF_T=[dD;dH;dS;dI;dR];
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%MODEL 2 Function
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function dM2_SF = M2_SF(t,a,params)
O = a(1); D = a(2); H = a(3); A = a(4); C = a(5); 
S = a(6); E = a(7);I = a(8); R = a(9);


PI=params(1);           delta_O=params(2);      mu_H=params(3);
gamma_H=params(4);      H_max=params(5);        delta_H=params(6);
gamma_A=params(7);      delta_A=params(8);      phi_A=params(9);
delta_C=params(10);     alpha_h=params(11);    
epsilon=params(12);     omega=params(13);       rho=params(14);
kappa=params(15);       psi=params(16);

dO=PI-delta_O*O;
dD=delta_O*O-mu_H*D*H;
dH=C*gamma_H*D*H*(1-(H/H_max))-delta_H*H;
dA=gamma_A*H-delta_A*A;
dC=phi_A*A*(1-(H/H_max))-delta_C*C;

dS=alpha_h*(S+I+R)-epsilon*S*A-omega*S;
dE=epsilon*S*A-psi*E-omega*E;
dI=psi*E-rho*I-kappa*I-omega*I;
dR=rho*I-omega*R;

dM2_SF=[dO;dD;dH;dA;dC;dS;dE;dI;dR];
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%MODEL 3 Function
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
function dM3_SF = M3_SF(t,a,params)
O = a(1); D = a(2); H = a(3); A = a(4); C = a(5); 
S = a(6); E = a(7); I = a(8); R = a(9);

PI=params(1); delta_O=params(2); mu_H=params(3);
gamma_H=params(4); H_max=params(5); delta_H=params(6);
gamma_A=params(7); delta_A=params(8); phi_A=params(9);
delta_C=params(10); T_opt_H=params(11); T_opt_A=params(12);
S_opt_H=params(13); S_opt_A=params(14); T_decay=params(15);
bl_Topt_A=params(16); ab_Topt_A=params(17); bl_Topt_H=params(18); 
ab_Topt_H=params(19); bl_Sopt_A=params(20); ab_Sopt_A=params(21); 
bl_Sopt_H=params(22); ab_Sopt_H=params(23);  alpha_h=params(24);      
epsilon=params(25);     omega=params(26);        
rho=params(27);   kappa=params(28);         psi=params(29);

%TF=40*sin(((2*pi)/365)*t)+70; %Mimics temperature annual temps of a simulated location with variation of 20-120
%S_m=49*sin(((2*pi)/365)*t-(pi/8))+50; %Mimics soil moisture of a simulated location with variation of 0-100
t_inf_data=[0;31;59;90;120;151;181;212;243;273;304;334;365;396;424;455;485;...
    516;546;577;608;638;669;699;730;761;789;820;850;881;911;942;973;1003;...
    1034;1064;1095;1126;1155;1186;1216;1247;1277;1308;1339;1369;1400;1430;...
    1461;1492;1520;1551;1581;1612;1642;1673;1704;1734;1765;1795;1826;1857;...
    1885;1916;1946;1977;2007;2038;2069;2099;2130;2160;2191;2222;2250;2281;...
    2311;2342;2372;2403;2434;2464;2495;2525;2556;2587;2616;2647;2677;2708;...
    2738;2769;2800;2830;2861;2891;2922;2953;2981;3012;3042;3073;3103;3134;...
    3165;3195;3226;3256;3287;3318;3346;3377;3407;3438;3468;3499;3530;3560;...
    3591;3621;3652;3683;3711;3742;3772;3803;3833;3864;3895;3925;3956;3986;4017];


temp_data_Maricopa=[50;52.9;65;69.8;78.2;88.5;91.4;89.6;83.2;69.2;62.1;52.3;...
    56.5;59.8;64.5;69.8;77.9;87.2;91.3;86.4;84.4;74.7;61.8;53.9;55.1;61.5;...
    67.2;68.8;73;88.1;89.4;92.3;85.6;74.7;58;50.7;51.7;61.8;65.6;69.2;74.7;...
    90.2;93.2;88.8;82.4;76.6;63.6;54.8;52;58.5;66.8;70.7;76.9;89.4;91.8;...
    90.4;82.8;76.2;67.4;56.9;58.4;56.2;62.6;73;78.1;87.1;91.9;90.3;87.4;...
    69.6;59.7;52.5;52.8;50.2;61.4;70.3;71.1;85.6;92.4;92.6;84.2;71;62.2;...
    52.5;53.5;55.7;60.3;69;81.2;86.7;94;94.7;87;76.6;63.9;52.9;53.2;57;59.9;...
    71.6;77.4;89.9;90.2;88.8;84.7;69.9;66.2;55.2;53.7;55;62.5;70.7;78;89;92;...
    89;86;72.4;55.5;51.5;50;52.6;56.8;68.7;76.5;81.7;96;92;84.2;74.9;63.2;55.6];

temp_data_Pima=[48.0; 49.5; 62.7; 66.7; 74.4; 85.6; 85.3; 83.9; 79.8; 67.1; 60.2;...
    50.8; 55.5; 58.1; 61.7; 66.6; 74.2; 85.2; 85.9; 82.1; 80.4; 72.2; 60.0; 52.1;...
    53.4; 59.7; 63.5; 65.6; 69.5; 84.6; 84.2; 86.9; 81.0; 71.9; 57.0; 49.5; 50.3;...
    59.6; 62.7; 65.9; 71.1; 86.1; 88.2; 83.4; 77.9; 74.2; 61.1; 53.7; 50.3; 57.1;...
    65.1; 68.3; 73.1; 85.9; 86.0; 84.8; 78.9; 74.7; 66.3; 55.1; 56.9; 55.0; 60.5;...
    70.6; 74.7; 84.1; 86.7; 85.1; 83.1; 67.4; 57.6; 51.1; 51.7; 48.6; 59.0; 67.0;...
    67.5; 81.4; 87.6; 87.2; 79.9; 68.7; 61.2; 51.6; 52.2; 52.8; 58.0; 66.1; 77.3;...
    83.2; 88.6; 89.6; 82.8; 73.9; 62.7; 50.9; 51.5; 54.8; 57.2; 68.5; 74.4; 86.6;...
    84.7; 83.9; 80.7; 68.0; 64.2; 54.2; 52.0; 52.0; 59.5; 67.8; 75.2; 84.9; 86.7;...
    83.3; 81.5; 68.9; 54.1; 50.5; 49.0; 50.3; 55.5; 65.9; 73.1; 79.1; 91.1; 87.3;...
    82.0; 73.1; 61.8; 54.0];

temp_data_Pinal=[48.2; 50.5; 62.6; 67.6; 76.5; 87.3; 88.2; 86.7; 81.4; 68.4; 60.7;...
    50.5; 54.4; 58.4; 62.5; 68.3; 76.3; 86.8; 88.6; 84.3; 81.9; 73.2; 60.2; 52.2;...
    52.8; 59.5; 64.6; 66.6; 71.6; 86.9; 87.0; 88.9; 82.0; 72.5; 56.4; 48.7; 50.1;...
    59.3; 63.4; 67.1; 73.6; 88.0; 90.1; 85.2; 80.3; 75.4; 62.1; 53.5; 50.8; 57.3;...
    65.0; 68.2; 74.9; 87.8; 88.0; 86.4; 81.1; 75.0; 66.2; 54.9; 56.4; 55.6; 61.1;...
    71.5; 76.9; 85.8; 89.0; 87.0; 84.3; 68.7; 58.0; 51.0; 50.9; 49.3; 59.3; 68.4;...
    69.7; 84.3; 90.3; 89.7; 82.5; 70.3; 61.3; 51.2; 51.5; 53.4; 58.8; 67.6; 79.4;...
    85.3; 91.1; 92.0; 84.6; 75.0; 62.6; 51.0; 52.0; 55.8; 58.2; 69.8; 76.5; 88.4;...
    86.7; 85.7; 82.2; 69.2; 64.7; 54.8; 51.9; 52.3; 59.9; 68.9; 76.8; 87.3; 89.4;...
    85.8; 84.0; 70.7; 55.0; 50.4; 48.8; 51.1; 55.8; 67.0; 75.4; 81.2; 93.7; 90.0;...
    82.8; 74.4; 62.3; 53.9];

temp_data_AZ=[38.6; 42.2; 54.8; 59.4; 67.4; 79.5; 81.0; 78.5; 72.4; 58.8; 51.3;...
41.5; 46.5; 50.0; 53.9; 59.1; 66.8; 77.7; 81.4; 76.5; 74.2; 64.9; 51.7; 44.3; 45.1;...
52.0; 56.3; 58.4; 62.9; 78.4; 78.6; 80.6; 75.0; 64.5; 48.3; 40.9; 41.8; 50.6; 54.9;...
58.5; 64.6; 80.3; 82.4; 77.5; 71.6; 66.1; 53.1; 44.7; 42.3; 49.4; 56.6; 59.9; 66.1;...
79.8; 81.5; 79.1; 72.4; 65.1; 57.6; 46.6; 47.6; 46.7; 52.3; 62.9; 68.5; 78.6; 82.3;...
80.2; 76.0; 59.9; 49.4; 42.8; 42.4; 40.9; 51.7; 60.3; 60.7; 75.2; 81.9; 81.9; 73.8;...
60.0; 52.1; 42.2; 43.7; 45.9; 51.0; 59.3; 70.5; 76.8; 82.8; 84.1; 75.6; 66.2; 53.5;...
42.0; 42.6; 46.5; 49.4; 61.2; 67.9; 80.6; 81.4; 79.5; 74.8; 59.9; 55.8; 45.6; 43.5;...
44.0; 51.8; 60.5; 68.6; 78.6; 82.2; 79.0; 75.9; 61.8; 46.1; 42.8; 40.3; 41.9; 47.2;...
58.4; 66.5; 72.4; 85.4; 80.7; 73.6; 64.4; 52.6; 45.4];


%palmer z-index
soil_mstr_data_Maricopa=[11.19;9.57;9.05;8.3;8.4;8.6;10.31;9.64;10.95;8.72;...
    13.29;8.92;7.68;7.11;8.73;7.78;7.86;8.47;10.07;13.74;15.11;9.01;8.2;...
    10.15;10.2;7.97;8.1;8.49;10.23;9.47;8.95;7.89;9.81;11.29;9.41;8.75;10.84;...
    7.72;6.72;8.7;8.68;8.92;7.67;10.57;8.92;8.19;9.67;10.84;11;11.25;8.09;...
    8.62;9.25;8.84;12.26;8.76;8.04;7.75;7.43;7.89;7.82;8.77;7.47;7.25;7.91;...
    8.98;13.33;10.48;8.17;16.69;9.11;8.62;9.84;13.51;10.12;9.43;10.42;9.92;...
    8.32;7.2;13.61;8.33;14.64;10.86;8.77;10.93;13.42;11.24;11.26;8.67;7.06;...
    7.09;7.46;7.71;8.02;8.8;9.8;7.94;8.14;7.53;7.91;8.81;15.97;12.66;9.59;...
    9.52;7.61;11.6;8.49;8.95;7.88;7.87;8.12;9.31;10.8;12.56;9.97;10.21;9.47;...
    11.1;11.67;10.64;11.91;11.03;11.01;9.89;7.22;7.43;9.54;7.93;8.66;9.77];

soil_mstr_data_Pima=[9.94;10.4;8.27;8.04;8.16;8.23;10.48;10.21;10.37;8.27;13.32;...
9.16;7.62;7.18;8.27;8.11;8.05;7.98;10.59;11.6;12.03;10.55;8.23;10.35;12.34;8.45;...
8.32;9.19;10.13;11.13;9.25;8.08;12.24;11.52;9.11;9.08;10.78;7.84;6.91;9.45;8.42;...
9.86;8.24;9.57;10.93;7.81;8.95;10.14;10.71;9.14;6.89;7.94;8.67;8.17;12.31;7.77;7.77;...
7.36;7.42;8.26;7.21;10.82;8;7.34;8.03;10.14;11.34;9.7;9.35;14.9;8.92;9.8;10.23;13.59;...
10.56;10.04;10.95;10.3;7.42;8.54;13.23;8.06;14.66;11.59;9.49;10.36;11.7;10.99;10.51;...
9.04;6.36;6.36;6.86;7.46;8.05;8.45;10.66;8.26;8.38;7.95;8.03;8.88;18.62;12.45;9.39;8.38;...
7.63;9.82;8.41;8.51;7.73;7.73;7.96;10.1;10.83;12.76;10.19;10.15;8.83;10.62;11.38;10.98;...
10.49;9.88;10.42;9.39;6.58;8.2;8.69;7.92;8.52;10.4];

soil_mstr_data_Pinal= [10.82; 9.64; 9.20; 8.65; 8.65; 8.40; 11.98; 8.05; 9.70;...
8.48; 12.07; 8.79; 7.53; 6.86; 8.95; 7.40; 7.51; 7.88; 8.81; 10.79; 14.72; 10.25;...
7.99; 10.15; 11.68; 8.12; 7.78; 9.04; 10.83; 10.48; 9.33; 9.75; 13.02; 11.84; 9.73;...
8.65; 10.84; 7.70; 6.75; 8.86; 8.33; 9.53; 7.85; 9.88; 9.85; 8.00; 9.60; 10.02; 10.87;...
8.92; 7.26; 7.86; 8.61; 8.31; 13.30; 9.20; 7.85; 7.50; 7.19; 7.94; 7.67; 9.63; 7.46; 6.74;...
7.52; 9.43; 11.60; 9.57; 10.68; 14.41; 9.01; 9.05; 9.83; 14.28; 9.55; 9.82; 10.37; 10.31;...
8.35; 6.86; 11.60; 8.08; 14.76; 11.76; 9.24; 10.30; 11.11; 10.56; 11.07; 8.67; 6.74; 6.69;...
7.18; 7.55; 8.15; 8.50; 9.84; 7.74; 8.15; 7.18; 7.49; 8.05; 18.35; 10.85; 11.11; 8.74; 7.43;...
10.29; 9.01; 8.97; 8.48; 7.22; 7.47; 9.72; 9.13; 12.40; 9.67; 10.03; 9.01; 12.06; 11.71; 10.98;...
10.68; 10.67; 11.82; 10.26; 6.83; 7.90; 9.35; 7.75; 8.99; 10.00];

soil_mstr_data_AZ=[10.62;9.22;8.26;7.91;8.25;7.71;11.94;10.43;11.66;8.52;12.04;...
8.76;7.16;6.9;8.03;7.26;7.22;6.88;9.67;12.5;12.95;8.7;7.98;10.2;10.95;8.23;8.67;8.47;...
10.74;10.34;10.35;9.59;10.03;11.91;9.92;8.87;10.34;7.49;6.66;8.81;8.83;8.16;8.32;11.03;...
10.42;7.91;9.67;11.41;12;10.17;7.85;8.52;10.04;8.96;12.46;8.01;8.45;7.26;6.84;7.38;7.64;...
9.06;7.82;5.99;7.16;7.63;11.46;9.36;8.46;14.53;8.8;8.9;10.48;13.67;10.25;9.89;11.96;...
10.88;7.47;6.54;10.97;7.91;14.44;11.23;8.92;10.21;12.52;10.47;11.24;9.56;6.77;5.54;6.75;...
7.38;8.08;8.18;9.89;7.85;8.99;7.1;7;7.21;14.84;9.74;9.84;9.69;7.21;10.62;8.14;8.52;8.52;...
6.77;6.97;8.74;10.66;12.3;10.1;10.64;9.4;10.35;12.34;10.55;12.46;9.84;11.96;10.83;6.61;...
8.88;9.72;7.75;8.67;9.03];

temp_data=temp_data_AZ;
soil_mstr_data=soil_mstr_data_AZ;

tind = [15.5;45;74.5;105;135.5;166;196.5;227.5;258;288.5;319;349.5;380.5;410;...
    439.5;470;500.5;531;561.5;592.5;623;653.5;684;714.5;745.5;775;804.5;835;...
    865.5;896;926.5;957.5;988;1018.5;1049;1079.5;1110.5;1140.5;1170.5;1201;...
    1231.5;1262;1292.5;1323.5;1354;1384.5;1415;1445.5;1476.5;1506;1535.5;1566;...
    1596.5;1627;1657.5;1688.5;1719;1749.5;1780;1810.5;1841.5;1871;1900.5;1931;...
    1961.5;1992;2022.5;2053.5;2084;2114.5;2145;2175.5;2206.5;2236;2265.5;2296;...
    2326.5;2357;2387.5;2418.5;2449;2479.5;2510;2540.5;2571.5;2601.5;2631.5;2662;...
    2692.5;2723;2753.5;2784.5;2815;2845.5;2876;2906.5;2937.5;2967;2996.5;3027;...
    3057.5;3088;3118.5;3149.5;3180;3210.5;3241;3271.5;3302.5;3332;3361.5;3392;...
    3422.5;3453;3483.5;3514.5;3545;3575.5;3606;3636.5;3667.5;3697;3726.5;3757;...
    3787.5;3818;3848.5;3879.5;3910; 3940.5; 3971; 4001.5];

TFSpchip=pchip(tind,temp_data);
%TFSpline=spline(tind,temp_data);
TF=ppval(TFSpchip, t);

S_mpchip=pchip(tind,soil_mstr_data);
%S_mSpline=spline(tind,soil_mstr_data);
S_m=ppval(S_mpchip, t);

%TF
if TF<T_opt_A || TF==T_opt_A
F_A_T=exp(-((TF-T_opt_A)^2/bl_Topt_A));
else
F_A_T=exp(-((TF-T_opt_A)^2/ab_Topt_A));
end

if TF<T_opt_H || TF==T_opt_H
F_H_T=exp(-((TF-T_opt_H)^2/bl_Topt_H));
else
F_H_T=exp(-((TF-T_opt_H)^2/ab_Topt_H));
end

if S_m<S_opt_A || S_m==S_opt_A
F_A_S_m=exp(-((S_m-S_opt_A)^2/bl_Sopt_A));
else
F_A_S_m=exp(-((S_m-S_opt_A)^2/ab_Sopt_A));
end

if S_m<S_opt_H || S_m==S_opt_H
F_H_S_m=exp(-((S_m-S_opt_H)^2/bl_Sopt_H));
else
F_H_S_m=exp(-((S_m-S_opt_H)^2/ab_Sopt_H));
end

dO=PI-(TF/T_decay)*delta_O*O;
dD=(TF/T_decay)*delta_O*O-(mu_H*H*D);
dH=C*gamma_H*H*D*(1-(H/H_max))*(F_H_T*F_H_S_m)-delta_H*H;
dA=gamma_A*H*(F_A_T*F_A_S_m)-delta_A*A;
dC=phi_A*A*(1-(H/H_max))-delta_C*C;

dS=alpha_h*(S+E+I+R)-epsilon*S*A-omega*S;
dE=epsilon*S*A-psi*E-omega*E;
dI=psi*E-rho*I-kappa*I-omega*I;
dR=rho*I-omega*R;

dM3_SF=[dO;dD;dH;dA;dC;dS;dE;dI;dR];
end




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%MODEL 4 SIMPLIFIED FUNCTION
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
function dM4_SF_S = M4_SF_S(t,a,params)
V=a(1); O = a(2); D = a(3); H = a(4); A = a(5); C = a(6); 
S= a(7); E= a(8); I= a(9); R= a(10);

delta_O=params(1);      mu_H=params(2);
gamma_H=params(3);      H_max=params(4);        delta_H=params(5);
gamma_A=params(6);      delta_A=params(7);      phi_A=params(8);
delta_C=params(9);     T_opt_H=params(10);     T_opt_A=params(11);
S_opt_H=params(12);     S_opt_A=params(13);     T_decay=params(14);
bl_Topt_A=params(15);   ab_Topt_A=params(16);   bl_Topt_H=params(17); 
ab_Topt_H=params(18);   bl_Sopt_A=params(19);   ab_Sopt_A=params(20); 
bl_Sopt_H=params(21);   ab_Sopt_H=params(22);   T_hs=params(23);
beta=params(24);        delta_V=params(25);     sigma=params(26); 
T_cs=params(27); 
alpha=params(28);       S_d_s=params(29);       T_d_s=params(30); 
xtr_c_s=params(31);
alpha_h=params(32);      delta_R=params(33);  epsilon=params(34);     
omega=params(35);        rho=params(36);     kappa=params(37);
psi=params(38);
%bl_S_H_s=params(34);    ab_T_H_s=params(35);

% TF=40*sin(((2*pi)/365)*t)+70; %Mimics temperature annual temps of a simulated location with variation of 20-120
% S_m=49*sin(((2*pi)/365)*t-(pi/8))+50; %Mimics soil moisture of a simulated location with variation of 0-100
t_inf_data=[0;31;59;90;120;151;181;212;243;273;304;334;365;396;424;455;485;...
    516;546;577;608;638;669;699;730;761;789;820;850;881;911;942;973;1003;...
    1034;1064;1095;1126;1155;1186;1216;1247;1277;1308;1339;1369;1400;1430;...
    1461;1492;1520;1551;1581;1612;1642;1673;1704;1734;1765;1795;1826;1857;...
    1885;1916;1946;1977;2007;2038;2069;2099;2130;2160;2191;2222;2250;2281;...
    2311;2342;2372;2403;2434;2464;2495;2525;2556;2587;2616;2647;2677;2708;...
    2738;2769;2800;2830;2861;2891;2922;2953;2981;3012;3042;3073;3103;3134;...
    3165;3195;3226;3256;3287;3318;3346;3377;3407;3438;3468;3499;3530;3560;...
    3591;3621;3652;3683;3711;3742;3772;3803;3833;3864;3895;3925;3956;3986;4017];

temp_data_Maricopa=[50;52.9;65;69.8;78.2;88.5;91.4;89.6;83.2;69.2;62.1;52.3;...
    56.5;59.8;64.5;69.8;77.9;87.2;91.3;86.4;84.4;74.7;61.8;53.9;55.1;61.5;...
    67.2;68.8;73;88.1;89.4;92.3;85.6;74.7;58;50.7;51.7;61.8;65.6;69.2;74.7;...
    90.2;93.2;88.8;82.4;76.6;63.6;54.8;52;58.5;66.8;70.7;76.9;89.4;91.8;...
    90.4;82.8;76.2;67.4;56.9;58.4;56.2;62.6;73;78.1;87.1;91.9;90.3;87.4;...
    69.6;59.7;52.5;52.8;50.2;61.4;70.3;71.1;85.6;92.4;92.6;84.2;71;62.2;...
    52.5;53.5;55.7;60.3;69;81.2;86.7;94;94.7;87;76.6;63.9;52.9;53.2;57;59.9;...
    71.6;77.4;89.9;90.2;88.8;84.7;69.9;66.2;55.2;53.7;55;62.5;70.7;78;89;92;...
    89;86;72.4;55.5;51.5;50;52.6;56.8;68.7;76.5;81.7;96;92;84.2;74.9;63.2;55.6];

%palmer z-index
soil_mstr_data_Maricopa=[11.19;9.57;9.05;8.3;8.4;8.6;10.31;9.64;10.95;8.72;...
    13.29;8.92;7.68;7.11;8.73;7.78;7.86;8.47;10.07;13.74;15.11;9.01;8.2;...
    10.15;10.2;7.97;8.1;8.49;10.23;9.47;8.95;7.89;9.81;11.29;9.41;8.75;10.84;...
    7.72;6.72;8.7;8.68;8.92;7.67;10.57;8.92;8.19;9.67;10.84;11;11.25;8.09;...
    8.62;9.25;8.84;12.26;8.76;8.04;7.75;7.43;7.89;7.82;8.77;7.47;7.25;7.91;...
    8.98;13.33;10.48;8.17;16.69;9.11;8.62;9.84;13.51;10.12;9.43;10.42;9.92;...
    8.32;7.2;13.61;8.33;14.64;10.86;8.77;10.93;13.42;11.24;11.26;8.67;7.06;...
    7.09;7.46;7.71;8.02;8.8;9.8;7.94;8.14;7.53;7.91;8.81;15.97;12.66;9.59;...
    9.52;7.61;11.6;8.49;8.95;7.88;7.87;8.12;9.31;10.8;12.56;9.97;10.21;9.47;...
    11.1;11.67;10.64;11.91;11.03;11.01;9.89;7.22;7.43;9.54;7.93;8.66;9.77];

temp_data=temp_data_Maricopa;
soil_mstr_data=soil_mstr_data_Maricopa;
%t
% indexer=1;
% while indexer<=length(t_inf_data)
%     if t==0
%         TF=temp_data(indexer);
%         S_m=soil_mstr_data(indexer); 
%         indexer=length(t_inf_data)+1;
%     elseif t<=t_inf_data(indexer)
%         TF=temp_data(indexer-1);
%         S_m=soil_mstr_data(indexer-1);
%         indexer=length(t_inf_data)+1;
%     else
%         indexer=indexer+1;
%     end
% end
 %size(t_inf_data)
 %size(temp_data)
% size(soil_mstr_data)
% TF=interp1(t_inf_data,[0;temp_data],t,'next');
% S_m=interp1(t_inf_data,[0;soil_mstr_data],t,'next');
% TFt-TF
% S_mt-S_m
tind = [15.5;45;74.5;105;135.5;166;196.5;227.5;258;288.5;319;349.5;380.5;410;...
    439.5;470;500.5;531;561.5;592.5;623;653.5;684;714.5;745.5;775;804.5;835;...
    865.5;896;926.5;957.5;988;1018.5;1049;1079.5;1110.5;1140.5;1170.5;1201;...
    1231.5;1262;1292.5;1323.5;1354;1384.5;1415;1445.5;1476.5;1506;1535.5;1566;...
    1596.5;1627;1657.5;1688.5;1719;1749.5;1780;1810.5;1841.5;1871;1900.5;1931;...
    1961.5;1992;2022.5;2053.5;2084;2114.5;2145;2175.5;2206.5;2236;2265.5;2296;...
    2326.5;2357;2387.5;2418.5;2449;2479.5;2510;2540.5;2571.5;2601.5;2631.5;2662;...
    2692.5;2723;2753.5;2784.5;2815;2845.5;2876;2906.5;2937.5;2967;2996.5;3027;...
    3057.5;3088;3118.5;3149.5;3180;3210.5;3241;3271.5;3302.5;3332;3361.5;3392;...
    3422.5;3453;3483.5;3514.5;3545;3575.5;3606;3636.5;3667.5;3697;3726.5;3757;...
    3787.5;3818;3848.5;3879.5;3910; 3940.5; 3971; 4001.5];

TFSpchip=pchip(tind,temp_data);
%TFSpline=spline(tind,temp_data);
TF=ppval(TFSpchip, t);

S_mpchip=pchip(tind,soil_mstr_data);
%S_mSpline=spline(tind,soil_mstr_data);
S_m=ppval(S_mpchip, t);

if TF<T_opt_A || TF==T_opt_A
F_A_T=exp(-((TF-T_opt_A)^2/bl_Topt_A));
else
F_A_T=exp(-((TF-T_opt_A)^2/ab_Topt_A));
end

if TF<T_opt_H || TF==T_opt_H
F_H_T=exp(-((TF-T_opt_H)^2/bl_Topt_H));
else
F_H_T=exp(-((TF-T_opt_H)^2/ab_Topt_H));
end

if S_m<S_opt_A || S_m==S_opt_A
F_A_S_m=exp(-((S_m-S_opt_A)^2/bl_Sopt_A));
else
F_A_S_m=exp(-((S_m-S_opt_A)^2/ab_Sopt_A));
end

if S_m<S_opt_H || S_m==S_opt_H
F_H_S_m=exp(-((S_m-S_opt_H)^2/bl_Sopt_H));
else
F_H_S_m=exp(-((S_m-S_opt_H)^2/ab_Sopt_H));
end

% if S_m<S_d_s && TF>T_d_s
%   F_dr=exp(-((S_m-S_d_s)^2/bl_S_d_s))*exp(-((TF-T_d_s)^2/ab_T_d_s));
% else
%     F_H_dr=1;
% end

if S_m<S_d_s %&& TF>T_d_s %&& xtr_c_s*(S_d_s/S_m)*(TF/T_d_s)>1
%F_H_dr=xtr_c_s*(S_d_s/S_m)*(TF/T_d_s);
%F_dr=exp(((S_d_s-S_m)/S_d_s)*((TF-T_d_s)/T_d_s)*xtr_c_s);
F_dr=exp(((S_d_s-S_m)/S_d_s)*xtr_c_s);
else
    F_dr=1;
end

dV=((1/(1+exp(TF-T_hs)))-(1/(1+exp(TF-T_cs))))*beta*V-delta_V*V;
dO=-(TF/T_decay)*delta_O*O+delta_V*V;
dD=(TF/T_decay)*(delta_O*O+sigma*V)-(mu_H*H*D);
dH=C*gamma_H*H*D*(1-(H/H_max))*(F_H_T*F_H_S_m)-delta_H*H*F_dr;
dA=gamma_A*H*(F_A_T*F_A_S_m)-delta_A*A;
dC=(alpha*A*V+phi_A*A)*(1-(H/H_max))-delta_C*C;

dS=alpha_h*(S+E+I+R)+delta_R*R-epsilon*S*A-omega*S;
dE=epsilon*S*A-psi*E-omega*E;
dI=psi*E-rho*I-kappa*I-omega*I;
dR=rho*I-delta_R*R-omega*R;

dM4_SF_S=[dV;dO;dD;dH;dA;dC;dS;dE;dI;dR];
end



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%MODEL 5
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
function dM5_SF = M5_SF(t,a,params)
V=a(1); O = a(2); D = a(3); H = a(4); A = a(5); C = a(6); 
S=a(7); E = a(8); A_H=a(9); I =a(10); R =a(11);

k_ref=params(1);        Q_18=params(2);         T_ref=params(3);      mu_H=params(4);
gamma_H=params(5);      H_max=params(6);        delta_H=params(7);
gamma_A=params(8);      delta_A=params(9);      phi_A=params(10);
delta_C=params(11);     T_opt_H=params(12);     T_opt_A=params(13);
S_opt_H=params(14);     S_opt_A=params(15);     
bl_Topt_A=params(16);   ab_Topt_A=params(17);   bl_Topt_H=params(18); 
ab_Topt_H=params(19);   bl_Sopt_A=params(20);   ab_Sopt_A=params(21); 
bl_Sopt_H=params(22);   ab_Sopt_H=params(23);   T_hs=params(24);
beta=params(25);        delta_V=params(26);
sigma=params(27);       T_cs=params(28); 
alpha=params(29);       S_d_s=params(30);       T_d_s=params(31); 
xtr_c_s=params(32);
alpha_h=params(33);     epsilon=params(34);     
omega=params(35);       rho=params(36);         kappa=params(37);
psi=params(38);        
%bl_S_H_s=params(34);    ab_T_H_s=params(35);

t_inf_data=[0;31;59;90;120;151;181;212;243;273;304;334;365;396;424;455;485;...
    516;546;577;608;638;669;699;730;761;789;820;850;881;911;942;973;1003;...
    1034;1064;1095;1126;1155;1186;1216;1247;1277;1308;1339;1369;1400;1430;...
    1461;1492;1520;1551;1581;1612;1642;1673;1704;1734;1765;1795;1826;1857;...
    1885;1916;1946;1977;2007;2038;2069;2099;2130;2160;2191;2222;2250;2281;...
    2311;2342;2372;2403;2434;2464;2495;2525;2556;2587;2616;2647;2677;2708;...
    2738;2769;2800;2830;2861;2891;2922;2953;2981;3012;3042;3073;3103;3134;...
    3165;3195;3226;3256;3287;3318;3346;3377;3407;3438;3468;3499;3530;3560;...
    3591;3621;3652;3683;3711;3742;3772;3803;3833;3864;3895;3925;3956;3986;4017];


temp_data_Maricopa=[50;52.9;65;69.8;78.2;88.5;91.4;89.6;83.2;69.2;62.1;52.3;...
    56.5;59.8;64.5;69.8;77.9;87.2;91.3;86.4;84.4;74.7;61.8;53.9;55.1;61.5;...
    67.2;68.8;73;88.1;89.4;92.3;85.6;74.7;58;50.7;51.7;61.8;65.6;69.2;74.7;...
    90.2;93.2;88.8;82.4;76.6;63.6;54.8;52;58.5;66.8;70.7;76.9;89.4;91.8;...
    90.4;82.8;76.2;67.4;56.9;58.4;56.2;62.6;73;78.1;87.1;91.9;90.3;87.4;...
    69.6;59.7;52.5;52.8;50.2;61.4;70.3;71.1;85.6;92.4;92.6;84.2;71;62.2;...
    52.5;53.5;55.7;60.3;69;81.2;86.7;94;94.7;87;76.6;63.9;52.9;53.2;57;59.9;...
    71.6;77.4;89.9;90.2;88.8;84.7;69.9;66.2;55.2;53.7;55;62.5;70.7;78;89;92;...
    89;86;72.4;55.5;51.5;50;52.6;56.8;68.7;76.5;81.7;96;92;84.2;74.9;63.2;55.6];

temp_data_Pima=[48.0; 49.5; 62.7; 66.7; 74.4; 85.6; 85.3; 83.9; 79.8; 67.1; 60.2;...
    50.8; 55.5; 58.1; 61.7; 66.6; 74.2; 85.2; 85.9; 82.1; 80.4; 72.2; 60.0; 52.1;...
    53.4; 59.7; 63.5; 65.6; 69.5; 84.6; 84.2; 86.9; 81.0; 71.9; 57.0; 49.5; 50.3;...
    59.6; 62.7; 65.9; 71.1; 86.1; 88.2; 83.4; 77.9; 74.2; 61.1; 53.7; 50.3; 57.1;...
    65.1; 68.3; 73.1; 85.9; 86.0; 84.8; 78.9; 74.7; 66.3; 55.1; 56.9; 55.0; 60.5;...
    70.6; 74.7; 84.1; 86.7; 85.1; 83.1; 67.4; 57.6; 51.1; 51.7; 48.6; 59.0; 67.0;...
    67.5; 81.4; 87.6; 87.2; 79.9; 68.7; 61.2; 51.6; 52.2; 52.8; 58.0; 66.1; 77.3;...
    83.2; 88.6; 89.6; 82.8; 73.9; 62.7; 50.9; 51.5; 54.8; 57.2; 68.5; 74.4; 86.6;...
    84.7; 83.9; 80.7; 68.0; 64.2; 54.2; 52.0; 52.0; 59.5; 67.8; 75.2; 84.9; 86.7;...
    83.3; 81.5; 68.9; 54.1; 50.5; 49.0; 50.3; 55.5; 65.9; 73.1; 79.1; 91.1; 87.3;...
    82.0; 73.1; 61.8; 54.0];

temp_data_Pinal=[48.2; 50.5; 62.6; 67.6; 76.5; 87.3; 88.2; 86.7; 81.4; 68.4; 60.7;...
    50.5; 54.4; 58.4; 62.5; 68.3; 76.3; 86.8; 88.6; 84.3; 81.9; 73.2; 60.2; 52.2;...
    52.8; 59.5; 64.6; 66.6; 71.6; 86.9; 87.0; 88.9; 82.0; 72.5; 56.4; 48.7; 50.1;...
    59.3; 63.4; 67.1; 73.6; 88.0; 90.1; 85.2; 80.3; 75.4; 62.1; 53.5; 50.8; 57.3;...
    65.0; 68.2; 74.9; 87.8; 88.0; 86.4; 81.1; 75.0; 66.2; 54.9; 56.4; 55.6; 61.1;...
    71.5; 76.9; 85.8; 89.0; 87.0; 84.3; 68.7; 58.0; 51.0; 50.9; 49.3; 59.3; 68.4;...
    69.7; 84.3; 90.3; 89.7; 82.5; 70.3; 61.3; 51.2; 51.5; 53.4; 58.8; 67.6; 79.4;...
    85.3; 91.1; 92.0; 84.6; 75.0; 62.6; 51.0; 52.0; 55.8; 58.2; 69.8; 76.5; 88.4;...
    86.7; 85.7; 82.2; 69.2; 64.7; 54.8; 51.9; 52.3; 59.9; 68.9; 76.8; 87.3; 89.4;...
    85.8; 84.0; 70.7; 55.0; 50.4; 48.8; 51.1; 55.8; 67.0; 75.4; 81.2; 93.7; 90.0;...
    82.8; 74.4; 62.3; 53.9];

temp_data_AZ=[38.6; 42.2; 54.8; 59.4; 67.4; 79.5; 81.0; 78.5; 72.4; 58.8; 51.3;...
41.5; 46.5; 50.0; 53.9; 59.1; 66.8; 77.7; 81.4; 76.5; 74.2; 64.9; 51.7; 44.3; 45.1;...
52.0; 56.3; 58.4; 62.9; 78.4; 78.6; 80.6; 75.0; 64.5; 48.3; 40.9; 41.8; 50.6; 54.9;...
58.5; 64.6; 80.3; 82.4; 77.5; 71.6; 66.1; 53.1; 44.7; 42.3; 49.4; 56.6; 59.9; 66.1;...
79.8; 81.5; 79.1; 72.4; 65.1; 57.6; 46.6; 47.6; 46.7; 52.3; 62.9; 68.5; 78.6; 82.3;...
80.2; 76.0; 59.9; 49.4; 42.8; 42.4; 40.9; 51.7; 60.3; 60.7; 75.2; 81.9; 81.9; 73.8;...
60.0; 52.1; 42.2; 43.7; 45.9; 51.0; 59.3; 70.5; 76.8; 82.8; 84.1; 75.6; 66.2; 53.5;...
42.0; 42.6; 46.5; 49.4; 61.2; 67.9; 80.6; 81.4; 79.5; 74.8; 59.9; 55.8; 45.6; 43.5;...
44.0; 51.8; 60.5; 68.6; 78.6; 82.2; 79.0; 75.9; 61.8; 46.1; 42.8; 40.3; 41.9; 47.2;...
58.4; 66.5; 72.4; 85.4; 80.7; 73.6; 64.4; 52.6; 45.4];


%palmer z-index
soil_mstr_data_Maricopa=[11.19;9.57;9.05;8.3;8.4;8.6;10.31;9.64;10.95;8.72;...
    13.29;8.92;7.68;7.11;8.73;7.78;7.86;8.47;10.07;13.74;15.11;9.01;8.2;...
    10.15;10.2;7.97;8.1;8.49;10.23;9.47;8.95;7.89;9.81;11.29;9.41;8.75;10.84;...
    7.72;6.72;8.7;8.68;8.92;7.67;10.57;8.92;8.19;9.67;10.84;11;11.25;8.09;...
    8.62;9.25;8.84;12.26;8.76;8.04;7.75;7.43;7.89;7.82;8.77;7.47;7.25;7.91;...
    8.98;13.33;10.48;8.17;16.69;9.11;8.62;9.84;13.51;10.12;9.43;10.42;9.92;...
    8.32;7.2;13.61;8.33;14.64;10.86;8.77;10.93;13.42;11.24;11.26;8.67;7.06;...
    7.09;7.46;7.71;8.02;8.8;9.8;7.94;8.14;7.53;7.91;8.81;15.97;12.66;9.59;...
    9.52;7.61;11.6;8.49;8.95;7.88;7.87;8.12;9.31;10.8;12.56;9.97;10.21;9.47;...
    11.1;11.67;10.64;11.91;11.03;11.01;9.89;7.22;7.43;9.54;7.93;8.66;9.77];

soil_mstr_data_Pima=[9.94;10.4;8.27;8.04;8.16;8.23;10.48;10.21;10.37;8.27;13.32;...
9.16;7.62;7.18;8.27;8.11;8.05;7.98;10.59;11.6;12.03;10.55;8.23;10.35;12.34;8.45;...
8.32;9.19;10.13;11.13;9.25;8.08;12.24;11.52;9.11;9.08;10.78;7.84;6.91;9.45;8.42;...
9.86;8.24;9.57;10.93;7.81;8.95;10.14;10.71;9.14;6.89;7.94;8.67;8.17;12.31;7.77;7.77;...
7.36;7.42;8.26;7.21;10.82;8;7.34;8.03;10.14;11.34;9.7;9.35;14.9;8.92;9.8;10.23;13.59;...
10.56;10.04;10.95;10.3;7.42;8.54;13.23;8.06;14.66;11.59;9.49;10.36;11.7;10.99;10.51;...
9.04;6.36;6.36;6.86;7.46;8.05;8.45;10.66;8.26;8.38;7.95;8.03;8.88;18.62;12.45;9.39;8.38;...
7.63;9.82;8.41;8.51;7.73;7.73;7.96;10.1;10.83;12.76;10.19;10.15;8.83;10.62;11.38;10.98;...
10.49;9.88;10.42;9.39;6.58;8.2;8.69;7.92;8.52;10.4];

soil_mstr_data_Pinal= [10.82; 9.64; 9.20; 8.65; 8.65; 8.40; 11.98; 8.05; 9.70;...
8.48; 12.07; 8.79; 7.53; 6.86; 8.95; 7.40; 7.51; 7.88; 8.81; 10.79; 14.72; 10.25;...
7.99; 10.15; 11.68; 8.12; 7.78; 9.04; 10.83; 10.48; 9.33; 9.75; 13.02; 11.84; 9.73;...
8.65; 10.84; 7.70; 6.75; 8.86; 8.33; 9.53; 7.85; 9.88; 9.85; 8.00; 9.60; 10.02; 10.87;...
8.92; 7.26; 7.86; 8.61; 8.31; 13.30; 9.20; 7.85; 7.50; 7.19; 7.94; 7.67; 9.63; 7.46; 6.74;...
7.52; 9.43; 11.60; 9.57; 10.68; 14.41; 9.01; 9.05; 9.83; 14.28; 9.55; 9.82; 10.37; 10.31;...
8.35; 6.86; 11.60; 8.08; 14.76; 11.76; 9.24; 10.30; 11.11; 10.56; 11.07; 8.67; 6.74; 6.69;...
7.18; 7.55; 8.15; 8.50; 9.84; 7.74; 8.15; 7.18; 7.49; 8.05; 18.35; 10.85; 11.11; 8.74; 7.43;...
10.29; 9.01; 8.97; 8.48; 7.22; 7.47; 9.72; 9.13; 12.40; 9.67; 10.03; 9.01; 12.06; 11.71; 10.98;...
10.68; 10.67; 11.82; 10.26; 6.83; 7.90; 9.35; 7.75; 8.99; 10.00];

soil_mstr_data_AZ=[10.62;9.22;8.26;7.91;8.25;7.71;11.94;10.43;11.66;8.52;12.04;...
8.76;7.16;6.9;8.03;7.26;7.22;6.88;9.67;12.5;12.95;8.7;7.98;10.2;10.95;8.23;8.67;8.47;...
10.74;10.34;10.35;9.59;10.03;11.91;9.92;8.87;10.34;7.49;6.66;8.81;8.83;8.16;8.32;11.03;...
10.42;7.91;9.67;11.41;12;10.17;7.85;8.52;10.04;8.96;12.46;8.01;8.45;7.26;6.84;7.38;7.64;...
9.06;7.82;5.99;7.16;7.63;11.46;9.36;8.46;14.53;8.8;8.9;10.48;13.67;10.25;9.89;11.96;...
10.88;7.47;6.54;10.97;7.91;14.44;11.23;8.92;10.21;12.52;10.47;11.24;9.56;6.77;5.54;6.75;...
7.38;8.08;8.18;9.89;7.85;8.99;7.1;7;7.21;14.84;9.74;9.84;9.69;7.21;10.62;8.14;8.52;8.52;...
6.77;6.97;8.74;10.66;12.3;10.1;10.64;9.4;10.35;12.34;10.55;12.46;9.84;11.96;10.83;6.61;...
8.88;9.72;7.75;8.67;9.03];

temp_data=temp_data_Pinal;
soil_mstr_data=soil_mstr_data_Pinal;
%t
% indexer=1;
% while indexer<=length(t_inf_data)
%     if t==0
%         TF=temp_data(indexer);
%         S_m=soil_mstr_data(indexer); 
%         indexer=length(t_inf_data)+1;
%     elseif t<=t_inf_data(indexer)
%         TF=temp_data(indexer-1);
%         S_m=soil_mstr_data(indexer-1);
%         indexer=length(t_inf_data)+1;
%     else
%         indexer=indexer+1;
%     end
% end
 %size(t_inf_data)
 %size(temp_data)
% size(soil_mstr_data)
% TF=interp1(t_inf_data,[0;temp_data],t,'next');
% S_m=interp1(t_inf_data,[0;soil_mstr_data],t,'next');
% TFt-TF
% S_mt-S_m
tind = [15.5;45;74.5;105;135.5;166;196.5;227.5;258;288.5;319;349.5;380.5;410;...
    439.5;470;500.5;531;561.5;592.5;623;653.5;684;714.5;745.5;775;804.5;835;...
    865.5;896;926.5;957.5;988;1018.5;1049;1079.5;1110.5;1140.5;1170.5;1201;...
    1231.5;1262;1292.5;1323.5;1354;1384.5;1415;1445.5;1476.5;1506;1535.5;1566;...
    1596.5;1627;1657.5;1688.5;1719;1749.5;1780;1810.5;1841.5;1871;1900.5;1931;...
    1961.5;1992;2022.5;2053.5;2084;2114.5;2145;2175.5;2206.5;2236;2265.5;2296;...
    2326.5;2357;2387.5;2418.5;2449;2479.5;2510;2540.5;2571.5;2601.5;2631.5;2662;...
    2692.5;2723;2753.5;2784.5;2815;2845.5;2876;2906.5;2937.5;2967;2996.5;3027;...
    3057.5;3088;3118.5;3149.5;3180;3210.5;3241;3271.5;3302.5;3332;3361.5;3392;...
    3422.5;3453;3483.5;3514.5;3545;3575.5;3606;3636.5;3667.5;3697;3726.5;3757;...
    3787.5;3818;3848.5;3879.5;3910; 3940.5; 3971; 4001.5];

TFSpchip=pchip(tind,temp_data);
%TFSpline=spline(tind,temp_data);
TF=ppval(TFSpchip, t);

S_mpchip=pchip(tind,soil_mstr_data);
%S_mSpline=spline(tind,soil_mstr_data);
S_m=ppval(S_mpchip, t);

if TF<T_opt_A || TF==T_opt_A
F_A_T=exp(-((TF-T_opt_A)^2/bl_Topt_A));
else
F_A_T=exp(-((TF-T_opt_A)^2/ab_Topt_A));
end

if TF<T_opt_H || TF==T_opt_H
F_H_T=exp(-((TF-T_opt_H)^2/bl_Topt_H));
else
F_H_T=exp(-((TF-T_opt_H)^2/ab_Topt_H));
end

if S_m<S_opt_A || S_m==S_opt_A
F_A_S_m=exp(-((S_m-S_opt_A)^2/bl_Sopt_A));
else
F_A_S_m=exp(-((S_m-S_opt_A)^2/ab_Sopt_A));
end

if S_m<S_opt_H || S_m==S_opt_H
F_H_S_m=exp(-((S_m-S_opt_H)^2/bl_Sopt_H));
else
F_H_S_m=exp(-((S_m-S_opt_H)^2/ab_Sopt_H));
end

% if S_m<S_d_s && TF>T_d_s
%   F_dr=exp(-((S_m-S_d_s)^2/bl_S_d_s))*exp(-((TF-T_d_s)^2/ab_T_d_s));
% else
%     F_H_dr=1;
% end

if S_m<S_d_s %&& TF>T_d_s %&& xtr_c_s*(S_d_s/S_m)*(TF/T_d_s)>1
%F_H_dr=xtr_c_s*(S_d_s/S_m)*(TF/T_d_s);
%F_dr=exp(((S_d_s-S_m)/S_d_s)*((TF-T_d_s)/T_d_s)*xtr_c_s);
F_dr=exp(((S_d_s-S_m)/S_d_s)*xtr_c_s);
else
    F_dr=1;
end

dV=((1/(1+exp(TF-T_hs)))-(1/(1+exp(TF-T_cs))))*beta*V-delta_V*V;
dO=delta_V*V-k_ref*Q_18^((TF-T_ref)/18)*O;
dD=k_ref*Q_18^((TF-T_ref)/18)*(O)+sigma*V-(mu_H*H*D);
dH=C*gamma_H*H*D*(1-(H/H_max))*(F_H_T*F_H_S_m)-delta_H*H*F_dr;
dA=gamma_A*H*(F_A_T*F_A_S_m)-delta_A*A;
dC=(alpha*A*V+phi_A*A)*(1-(H/H_max))-delta_C*C;

dS=alpha_h*(S+E+A_H+I+R)-epsilon*S*A-omega*S;
dE=epsilon*S*A-psi*E-omega*E;
dA_H=(1-psi)*E-omega*A_H;
dI=psi*E-rho*I-kappa*I-omega*I;
dR=rho*I-omega*R;

dM5_SF=[dV;dO;dD;dH;dA;dC;dS;dE;dA_H;dI;dR];
end
